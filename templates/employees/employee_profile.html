{% extends "base.html" %}
{% block title %}{{ employee.name }}{% endblock %}

{% block content %}

{% with DELETE_ENABLED=True %}

<!-- Back Navigation -->
<a href="{% url 'employees:employee_list' %}" class="text-decoration-none">
  ‚Üê Back to Employees
</a>

<!-- =========================
     EMPLOYEE HEADER
========================= -->
<div class="card mt-3 mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start">

      <div>
        <h3 class="mb-2">
          {{ employee.name }}
          <small class="text-muted">({{ employee.emp_code }})</small>
        </h3>

        <div class="mb-2">
          <span class="badge bg-primary me-2">
            Company: {{ employee.company.name }}
          </span>

          {% if employee.exit_date %}
            <span class="badge bg-secondary">Inactive</span>
          {% else %}
            <span class="badge bg-success">Active</span>
          {% endif %}
        </div>

        <div class="text-muted small">
          Joining Date: {{ employee.joining_date|date:"d M Y" }}
          {% if employee.exit_date %}
            ¬∑ Exit Date: {{ employee.exit_date|date:"d M Y" }}
          {% endif %}
        </div>
      </div>

      <div>
        <a href="{% url 'employees:employee_change_request' employee.id %}"
           class="btn btn-outline-secondary">
          ‚úèÔ∏è Request Profile Edit
        </a>
      </div>

    </div>
  </div>
</div>

<!-- =========================
     SALARY
========================= -->
<div class="card mb-4">
  <div class="card-header fw-semibold">Salary</div>
  <div class="card-body">
    {% if latest_salary %}
      <p class="mb-2">
        <strong>Last Salary:</strong>
        ‚Çπ{{ latest_salary.salary_amount }}
        <span class="text-muted">
          ({{ latest_salary.batch.month }}/{{ latest_salary.batch.year }})
        </span>
      </p>
      <a href="{% url 'dashboard:employee_salary_ledger' employee.id %}"
         class="btn btn-sm btn-outline-primary">
        View Full Salary Ledger
      </a>
    {% else %}
      <p class="text-muted mb-0">No salary records found.</p>
    {% endif %}
  </div>
</div>

<!-- =========================
     BANK ACCOUNTS
========================= -->
<div class="card mb-4">
  <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
    <span>Bank Accounts</span>
    <a href="{% url 'employees:bank_change' employee.id %}"
       class="btn btn-sm btn-outline-primary">
      ‚ûï Request Bank Change
    </a>
  </div>

  <div class="card-body">
    {% if active_account %}
      <div class="alert alert-info mb-3">
        <strong>Active Account</strong><br>
        {{ active_account.bank_name }}<br>
        A/C: {{ active_account.account_number }}<br>
        IFSC: {{ active_account.ifsc }}<br>
        <small class="text-muted">
          Approved by {{ active_account.approved_by|default:"‚Äî" }}
          on {{ active_account.approved_at|date:"d M Y" }}
        </small>
      </div>
    {% else %}
      <p class="text-muted">No active bank account.</p>
    {% endif %}

    <h6 class="mt-4 mb-3">Bank Account History</h6>

    {% if bank_accounts %}
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Bank</th>
              <th>Account</th>
              <th>IFSC</th>
              <th>Status</th>
              <th>Approved By</th>
              <th>Approved At</th>
            </tr>
          </thead>
          <tbody>
            {% for acc in bank_accounts %}
              <tr>
                <td>{{ acc.bank_name }}</td>
                <td>{{ acc.account_number }}</td>
                <td>{{ acc.ifsc }}</td>
                <td>
                  {% if acc.is_active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                  {% endif %}
                </td>
                <td>{{ acc.approved_by|default:"‚Äî" }}</td>
                <td>{{ acc.approved_at|date:"d M Y"|default:"‚Äî" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No bank history found.</p>
    {% endif %}
  </div>
</div>

<!-- =========================
     PENDING PROFILE CHANGES
========================= -->
{% if pending_changes %}
<div class="card mb-4 border-warning">
  <div class="card-header fw-semibold text-warning">
    ‚è≥ Pending Profile Change Requests
  </div>

  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Field</th>
            <th>Current Value</th>
            <th>Requested Value</th>
            <th>Requested By</th>
            <th>Requested At</th>
          </tr>
        </thead>
        <tbody>
          {% for req in pending_changes %}
            {% for field, values in req.changes.items %}
              <tr>
                <td>{{ field|capfirst }}</td>
                <td>{{ values.old|default:"‚Äî" }}</td>
                <td class="fw-semibold">{{ values.new|default:"‚Äî" }}</td>
                <td>{{ req.requested_by }}</td>
                <td>{{ req.requested_at|date:"d M Y H:i" }}</td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if request.user.is_staff %}
      <div class="mt-3 d-flex gap-2">
        <a href="{% url 'employees:approve_employee_change' employee.id %}"
           class="btn btn-success">
          ‚úÖ Approve All Changes
        </a>
        <a href="{% url 'employees:reject_employee_change' employee.id %}"
           class="btn btn-danger">
          ‚ùå Reject All Changes
        </a>
      </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- =========================
     DANGER ZONE (TEST MODE)
========================= -->
{% if DELETE_ENABLED %}
<hr>
<div class="card border-danger mb-4">
  <div class="card-header bg-danger text-white fw-semibold">
    ‚ö† Danger Zone (TEST MODE)
  </div>

  <div class="card-body">
    <p class="mb-2">
      <strong>TEST MODE ENABLED.</strong><br>
      Deletion is currently allowed for all users.
    </p>

    <form method="post"
          action="{% url 'employees:employee_delete' employee.id %}">
      {% csrf_token %}
      <button class="btn btn-danger"
              onclick="return confirm(
                'TEST MODE:\n\nThis will permanently delete the employee.\n\nContinue?'
              )">
        üóë Delete Employee (Test)
      </button>
    </form>
  </div>
</div>
{% endif %}

<!-- =========================
     ERROR REPORT
========================= -->
{% if request.session.employee_draft_upload_errors %}
<div class="mb-4">
  <a href="{% url 'employees:employee_draft_upload_errors' %}"
     class="btn btn-warning">
    ‚¨á Download Upload Error Report
  </a>
</div>
{% endif %}

{% endwith %}
{% endblock %}
