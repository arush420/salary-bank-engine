{% extends "base.html" %}
{% block title %}{{ employee.name }}{% endblock %}

{% block content %}

{% with DELETE_ENABLED=True %}

<!-- Back Navigation -->
<a href="{% url 'employees:employee_list' %}" class="text-decoration-none text-primary">
  <i class="bi bi-arrow-left"></i> Back to Employees
</a>

<!-- =========================
     EMPLOYEE HEADER & DETAILS
========================= -->
<div class="card mt-3 mb-4 shadow-sm">
  <div class="card-header bg-primary-subtle">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="bi bi-person-badge me-2"></i>Employee Information
      </h5>
      <a href="{% url 'employees:employee_change_request' employee.id %}"
         class="btn btn-outline-primary btn-sm">
        <i class="bi bi-pencil-square me-1"></i> Request Profile Edit
      </a>
    </div>
  </div>

  <div class="card-body">
    <!-- Employee Name and Status -->
    <div class="row mb-3 pb-3 border-bottom">
      <div class="col-md-8">
        <h3 class="mb-2">
          {{ employee.name }}
          <small class="text-muted fs-6">({{ employee.emp_code }})</small>
        </h3>

        <div class="mb-2">
          <span class="badge bg-primary me-2">
            <i class="bi bi-building me-1"></i>{{ employee.company.name }}
          </span>

          {% if employee.exit_date %}
            <span class="badge bg-secondary">
              <i class="bi bi-x-circle me-1"></i>Inactive
            </span>
          {% else %}
            <span class="badge bg-success">
              <i class="bi bi-check-circle me-1"></i>Active
            </span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Personal Details Grid -->
    <div class="row g-3">

      <!-- Father's Name -->
      {% if employee.father_name %}
      <div class="col-md-6">
        <div class="d-flex align-items-start">
          <i class="bi bi-person text-muted me-2 mt-1"></i>
          <div>
            <small class="text-muted d-block">Father's Name</small>
            <strong>{{ employee.father_name }}</strong>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Joining Date -->
      <div class="col-md-6">
        <div class="d-flex align-items-start">
          <i class="bi bi-calendar-check text-muted me-2 mt-1"></i>
          <div>
            <small class="text-muted d-block">Joining Date</small>
            <strong>{{ employee.joining_date|date:"d M Y" }}</strong>
          </div>
        </div>
      </div>

      <!-- Exit Date (if applicable) -->
      {% if employee.exit_date %}
      <div class="col-md-6">
        <div class="d-flex align-items-start">
          <i class="bi bi-calendar-x text-muted me-2 mt-1"></i>
          <div>
            <small class="text-muted d-block">Exit Date</small>
            <strong class="text-danger">{{ employee.exit_date|date:"d M Y" }}</strong>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- UAN Number -->
      {% if employee.uan_number %}
      <div class="col-md-6">
        <div class="d-flex align-items-start">
          <i class="bi bi-shield-check text-muted me-2 mt-1"></i>
          <div>
            <small class="text-muted d-block">UAN Number</small>
            <strong>{{ employee.uan_number }}</strong>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- ESIC Number -->
      {% if employee.esic_number %}
      <div class="col-md-6">
        <div class="d-flex align-items-start">
          <i class="bi bi-hospital text-muted me-2 mt-1"></i>
          <div>
            <small class="text-muted d-block">ESIC Number</small>
            <strong>{{ employee.esic_number }}</strong>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Document Number -->
      {% if employee.document_number %}
      <div class="col-md-6">
        <div class="d-flex align-items-start">
          <i class="bi bi-file-earmark-text text-muted me-2 mt-1"></i>
          <div>
            <small class="text-muted d-block">Document Number</small>
            <strong>{{ employee.document_number }}</strong>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Default Salary -->
      {% if employee.default_salary %}
      <div class="col-md-6">
        <div class="d-flex align-items-start">
          <i class="bi bi-cash-coin text-muted me-2 mt-1"></i>
          <div>
            <small class="text-muted d-block">Default Salary</small>
            <strong class="text-success">₹{{ employee.default_salary|floatformat:2 }}</strong>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- =========================
     SALARY
========================= -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-success-subtle">
    <h5 class="mb-0">
      <i class="bi bi-wallet2 me-2"></i>Salary Information
    </h5>
  </div>
  <div class="card-body">
    {% if latest_salary %}
      <div class="row align-items-center">
        <div class="col-md-8">
          <p class="mb-2">
            <strong>Last Salary:</strong>
            <span class="fs-5 text-success fw-bold">₹{{ latest_salary.salary_amount|floatformat:2 }}</span>
            <span class="text-muted ms-2">
              ({{ latest_salary.batch.month }}/{{ latest_salary.batch.year }})
            </span>
          </p>
        </div>
        <div class="col-md-4 text-md-end">
          <a href="{% url 'dashboard:employee_salary_ledger' employee.id %}"
             class="btn btn-sm btn-outline-success">
            <i class="bi bi-journal-text me-1"></i>View Full Ledger
          </a>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>No salary records found.
      </div>
    {% endif %}
  </div>
</div>

<!-- =========================
     BANK ACCOUNTS
========================= -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-info-subtle">
    <h5 class="mb-0">
      <i class="bi bi-bank me-2"></i>Bank Accounts
    </h5>
  </div>

  <div class="card-body">
    {% if active_account %}
      <div class="alert alert-info border-info mb-3">
        <h6 class="alert-heading">
          <i class="bi bi-check-circle-fill me-2"></i>Active Bank Account
        </h6>
        <hr>
        <div class="row g-2">
          <div class="col-md-4">
            <small class="text-muted d-block">Bank Name</small>
            <strong>{{ active_account.bank_name }}</strong>
          </div>
          <div class="col-md-4">
            <small class="text-muted d-block">Account Number</small>
            <strong>{{ active_account.account_number }}</strong>
          </div>
          <div class="col-md-4">
            <small class="text-muted d-block">IFSC Code</small>
            <strong>{{ active_account.ifsc }}</strong>
          </div>
        </div>
        <hr class="my-2">
        <small class="text-muted">
          <i class="bi bi-person-check me-1"></i>Approved by {{ active_account.approved_by|default:"System" }}
          on {{ active_account.approved_at|date:"d M Y" }}
        </small>
      </div>
    {% else %}
      <div class="alert alert-warning mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>No active bank account on record.
      </div>
    {% endif %}

    <!-- Bank Account History -->
    <h6 class="mt-4 mb-3 fw-semibold">
      <i class="bi bi-clock-history me-2"></i>Bank Account History
    </h6>

    {% if bank_accounts %}
      <div class="table-responsive">
        <table class="table table-sm table-hover table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col"><i class="bi bi-bank me-1"></i>Bank</th>
              <th scope="col"><i class="bi bi-credit-card me-1"></i>Account</th>
              <th scope="col"><i class="bi bi-code-square me-1"></i>IFSC</th>
              <th scope="col"><i class="bi bi-toggle-on me-1"></i>Status</th>
              <th scope="col"><i class="bi bi-person me-1"></i>Approved By</th>
              <th scope="col"><i class="bi bi-calendar me-1"></i>Approved At</th>
            </tr>
          </thead>
          <tbody>
            {% for acc in bank_accounts %}
              <tr{% if acc.is_active %} class="table-success"{% endif %}>
                <td>{{ acc.bank_name }}</td>
                <td><code>{{ acc.account_number }}</code></td>
                <td><code>{{ acc.ifsc }}</code></td>
                <td>
                  {% if acc.is_active %}
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle me-1"></i>Active
                    </span>
                  {% else %}
                    <span class="badge bg-secondary">
                      <i class="bi bi-dash-circle me-1"></i>Inactive
                    </span>
                  {% endif %}
                </td>
                <td>{{ acc.approved_by|default:"—" }}</td>
                <td>{{ acc.approved_at|date:"d M Y"|default:"—" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted mb-0">
        <i class="bi bi-info-circle me-2"></i>No bank account history available.
      </p>
    {% endif %}
  </div>
</div>

<!-- =========================
     PENDING PROFILE CHANGES
========================= -->
{% if pending_changes %}
<div class="card mb-4 border-warning shadow-sm">
  <div class="card-header bg-warning-subtle">
    <h5 class="mb-0 text-warning-emphasis">
      <i class="bi bi-hourglass-split me-2"></i>Pending Profile Change Requests
    </h5>
  </div>

  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Field</th>
            <th scope="col">Current Value</th>
            <th scope="col">Requested Value</th>
            <th scope="col">Requested By</th>
            <th scope="col">Requested At</th>
          </tr>
        </thead>
        <tbody>
          {% for req in pending_changes %}
            {% for field, values in req.changes.items %}
              <tr>
                <td><strong>{{ field|capfirst }}</strong></td>
                <td class="text-muted">{{ values.old|default:"—" }}</td>
                <td class="fw-semibold text-primary">{{ values.new|default:"—" }}</td>
                <td>{{ req.requested_by }}</td>
                <td>{{ req.requested_at|date:"d M Y H:i" }}</td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if request.user.is_staff %}
      <div class="mt-3 d-flex gap-2">
        <a href="{% url 'employees:approve_employee_change' employee.id %}"
           class="btn btn-success">
          <i class="bi bi-check-circle me-1"></i>Approve All Changes
        </a>
        <a href="{% url 'employees:reject_employee_change' employee.id %}"
           class="btn btn-danger">
          <i class="bi bi-x-circle me-1"></i>Reject All Changes
        </a>
      </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- =========================
     DANGER ZONE (TEST MODE)
========================= -->
{% if DELETE_ENABLED %}
<div class="card border-danger mb-4 shadow-sm">
  <div class="card-header bg-danger text-white">
    <h5 class="mb-0">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>Danger Zone (TEST MODE)
    </h5>
  </div>

  <div class="card-body">
    <div class="alert alert-danger mb-3">
      <strong><i class="bi bi-shield-exclamation me-2"></i>TEST MODE ENABLED</strong><br>
      Employee deletion is currently allowed for all users. This setting should be disabled in production.
    </div>

    <form method="post"
          action="{% url 'employees:employee_delete' employee.id %}"
          onsubmit="return confirm('⚠️ TEST MODE:\n\nThis will PERMANENTLY delete:\n• Employee: {{ employee.name }}\n• All associated records\n• This action CANNOT be undone\n\nAre you absolutely sure?');">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">
        <i class="bi bi-trash3 me-1"></i>Delete Employee (Test Mode)
      </button>
    </form>
  </div>
</div>
{% endif %}

<!-- =========================
     ERROR REPORT
========================= -->
{% if request.session.employee_draft_upload_errors %}
<div class="mb-4">
  <a href="{% url 'employees:employee_draft_upload_errors' %}"
     class="btn btn-warning">
    <i class="bi bi-download me-1"></i>Download Upload Error Report
  </a>
</div>
{% endif %}

{% endwith %}
{% endblock %}